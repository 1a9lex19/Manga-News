<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manga News</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f0f0; padding: 20px; }
        h1 { text-align: center; }
        input, select, button { padding: 10px; margin: 5px 0; width: 100%; max-width: 400px; }
        #results { margin-top: 20px; }
        .chapter { background: #fff; padding: 10px; margin-bottom: 5px; border-radius: 5px; }
    </style>
</head>
<body>
    <h1>Manga News</h1>
    <input type="text" id="mangaName" placeholder="Nom du manga">
    <select id="lang">
        <option value="en">VA (anglais)</option>
        <option value="fr">VF (français)</option>
    </select>
    <button onclick="searchManga()">Rechercher</button>
    <div id="results"></div>

    <script>
        async function fetchWithProxy(url) {
            const proxyUrl = 'https://api.allorigins.win/get?url=' + encodeURIComponent(url);
            const response = await fetch(proxyUrl);
            const data = await response.json();
            return JSON.parse(data.contents);
        }

        async function searchManga() {
            const mangaName = document.getElementById('mangaName').value.trim();
            const lang = document.getElementById('lang').value;
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = "Recherche en cours...";

            if (!mangaName) {
                resultsDiv.innerHTML = "Veuillez entrer un nom de manga.";
                return;
            }

            try {
                // Recherche du manga
                const searchData = await fetchWithProxy(`https://api.mangadex.org/manga?title=${encodeURIComponent(mangaName)}&limit=1`);
                if (!searchData.data || searchData.data.length === 0) {
                    resultsDiv.innerHTML = "Manga non trouvé.";
                    return;
                }

                const mangaId = searchData.data[0].id;

                // Récupérer le dernier chapitre
                const chapterData = await fetchWithProxy(`https://api.mangadex.org/chapter?manga=${mangaId}&translatedLanguage[]=${lang}&order[chapter]=desc&limit=1`);
                if (!chapterData.data || chapterData.data.length === 0) {
                    resultsDiv.innerHTML = "Aucun chapitre trouvé pour cette langue.";
                    return;
                }

                const chapter = chapterData.data[0].attributes;
                const chapterNumber = chapter.chapter || "Special/Extra";

                resultsDiv.innerHTML = `<div class="chapter">
                    <strong>${searchData.data[0].attributes.title.en || mangaName}</strong><br>
                    Dernier chapitre (${lang === 'fr' ? 'VF' : 'VA'}): ${chapterNumber}<br>
                    Sorti le: ${new Date(chapter.publishAt).toLocaleDateString()}
                </div>`;

                // Notification
                if ("Notification" in window && Notification.permission !== "denied") {
                    Notification.requestPermission().then(permission => {
                        if (permission === "granted") {
                            new Notification("Manga News", {
                                body: `Dernier chapitre de ${mangaName} : ${chapterNumber} (${lang === 'fr' ? 'VF' : 'VA'})`
                            });
                        }
                    });
                }

            } catch (err) {
                console.error(err);
                resultsDiv.innerHTML = "Erreur lors de la récupération des données.";
            }
        }
    </script>
</body>
</html>
